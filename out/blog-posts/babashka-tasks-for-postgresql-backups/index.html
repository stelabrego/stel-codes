<!DOCTYPE html><html><head><title>Creating Babashka tasks for postgresql backups | stel.codes</title><meta charset="utf-8" /><meta content="IE=edge" http-equiv="X-UA-Compatible" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/assets/icons/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180" /><link href="/assets/icons/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" /><link href="/assets/icons/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" /><link href="/assets/icons/site.webmanifest" rel="manifest" /><link color="#5bbad5" href="/assets/icons/safari-pinned-tab.svg" rel="mask-icon" /><link href="/assets/icons/favicon.ico" rel="shortcut icon" /><link href="/assets/css/main.css" rel="stylesheet" /><meta content="#da532c" name="msapplication-TileColor" /><meta content="/assets/icons/browserconfig.xml" name="msapplication-config" /><meta content="#ffffff" name="theme-color" /></head><body><header><nav><a href="/" id="brand"><img alt="" src="https://s3.stel.codes/nixos-logo.png" /><span>stel.codes</span></a><ul id="social"><li><a href="https://github.com/stelcodes">Github</a></li><li><a href="https://twitter.com/stelstuff">Twitter</a></li><li><a href="stel@stel.codes">Email</a></li></ul></nav></header><main><section class="welcome"><img alt="" class="avatar" src="https://user-images.githubusercontent.com/22163194/164172131-9086a741-caa7-4811-b5b0-96e3d0f93b7f.png" /><span class="name">Stel Abrego, Software Developer</span><div class="text"><p>Hi! I&apos;m a freelance software hacker with a focus on functional design and web technologies.</p><p>Check out my projects, learning resources, and blog posts.</p></div></section><section class="window"><div class="top"><?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="bars" preserveAspectRatio="none" width="100%" height="100%" viewBox="0 0 30 5" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g><path d="M29.803,0.285c0,-0.057 -0.045,-0.102 -0.102,-0.102l-29.373,-0c-0.056,-0 -0.101,0.045 -0.101,0.102l-0,0.203c-0,0.056 0.045,0.101 0.101,0.101l29.373,0c0.057,0 0.102,-0.045 0.102,-0.101l0,-0.203Z"/><path d="M29.803,1.143c0,-0.056 -0.045,-0.101 -0.102,-0.101l-29.373,-0c-0.056,-0 -0.101,0.045 -0.101,0.101l-0,0.203c-0,0.056 0.045,0.102 0.101,0.102l29.373,-0c0.057,-0 0.102,-0.046 0.102,-0.102l0,-0.203Z"/><path d="M29.803,2.002c0,-0.056 -0.045,-0.102 -0.102,-0.102l-29.373,0c-0.056,0 -0.101,0.046 -0.101,0.102l-0,0.203c-0,0.056 0.045,0.102 0.101,0.102l29.373,-0c0.057,-0 0.102,-0.046 0.102,-0.102l0,-0.203Z"/><path d="M29.803,2.859c0,-0.056 -0.045,-0.102 -0.102,-0.102l-29.373,0c-0.056,0 -0.101,0.046 -0.101,0.102l-0,0.203c-0,0.056 0.045,0.101 0.101,0.101l29.373,0c0.057,0 0.102,-0.045 0.102,-0.101l0,-0.203Z"/><path d="M29.803,3.716c0,-0.056 -0.045,-0.102 -0.102,-0.102l-29.373,0c-0.056,0 -0.101,0.046 -0.101,0.102l-0,0.203c-0,0.056 0.045,0.101 0.101,0.101l29.373,0c0.057,0 0.102,-0.045 0.102,-0.101l0,-0.203Z"/></g></svg>
<span class="title">blog posts</span><?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="bars" preserveAspectRatio="none" width="100%" height="100%" viewBox="0 0 30 5" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g><path d="M29.803,0.285c0,-0.057 -0.045,-0.102 -0.102,-0.102l-29.373,-0c-0.056,-0 -0.101,0.045 -0.101,0.102l-0,0.203c-0,0.056 0.045,0.101 0.101,0.101l29.373,0c0.057,0 0.102,-0.045 0.102,-0.101l0,-0.203Z"/><path d="M29.803,1.143c0,-0.056 -0.045,-0.101 -0.102,-0.101l-29.373,-0c-0.056,-0 -0.101,0.045 -0.101,0.101l-0,0.203c-0,0.056 0.045,0.102 0.101,0.102l29.373,-0c0.057,-0 0.102,-0.046 0.102,-0.102l0,-0.203Z"/><path d="M29.803,2.002c0,-0.056 -0.045,-0.102 -0.102,-0.102l-29.373,0c-0.056,0 -0.101,0.046 -0.101,0.102l-0,0.203c-0,0.056 0.045,0.102 0.101,0.102l29.373,-0c0.057,-0 0.102,-0.046 0.102,-0.102l0,-0.203Z"/><path d="M29.803,2.859c0,-0.056 -0.045,-0.102 -0.102,-0.102l-29.373,0c-0.056,0 -0.101,0.046 -0.101,0.102l-0,0.203c-0,0.056 0.045,0.101 0.101,0.101l29.373,0c0.057,0 0.102,-0.045 0.102,-0.101l0,-0.203Z"/><path d="M29.803,3.716c0,-0.056 -0.045,-0.102 -0.102,-0.102l-29.373,0c-0.056,0 -0.101,0.046 -0.101,0.102l-0,0.203c-0,0.056 0.045,0.101 0.101,0.101l29.373,0c0.057,0 0.102,-0.045 0.102,-0.101l0,-0.203Z"/></g></svg>
</div><div class="content"><article><img alt="" src="https://s3.stel.codes/e0122757-8024-44bc-aa9b-aee8948a8b25.jpeg" /><h1>Creating Babashka tasks for postgresql backups</h1><p class="subtitle">Why write a Bash script when you can use Clojure?!</p><p class="tags"><a class="tag" href="/tags/clojure/">#clojure</a><a class="tag" href="/tags/babashka/">#babashka</a></p><p>When it comes to relational databases, I love using PostgreSQL. It&apos;s fast, featureful, and very well documented. Postgres provides executables for backing up and restoring databases, called <code>pg_dump</code> and <code>pg_restore</code> respectively. You can read about them <a href="https://www.postgresql.org/docs/current/backup-dump.html">here</a>. For a long time I was typing these commands manually, but then I started desiring a script that could somewhat automate the process with timestamp filenames and confirmation prompts. So I started writing a basic shell script. But of course, writing shell scripts is a challenge for the majority of developers who aren&apos;t extremely familiar with the syntax. I&apos;m certainly not a Bash expert. Whenever I find myself writing loops or conditional expressions, I quickly grow tired and consider alternatives.</p><p>In the past this was Python, but since I began falling head over heels for Clojure, I much prefer it over other languages. Luckily, the Clojure community has some amazing open-source contributors like <a href="https://github.com/borkdude">Michiel Borkent AKA @borkdude</a>. Michiel created an amazing tool called <a href="https://babashka.org">Babashka</a> which (from what I understand) compiles a subset of Clojure into Bash, making it possible to write Clojure code in scripting situations without the startup penalty of JVM Clojure. This means you can write Clojure programs that execute seemingly instantaneously. Let&apos;s look at an example.</p><p>Typically, Babashka executes code inside of standard <code>.clj</code> files. As of version <code>0.4.0</code>, Babashka ships with a feature called &quot;tasks&quot; which executes Clojure code inside of the <code>bb.edn</code> file which Babashka uses for configuration. For example, a <code>bb.edn</code> file with a simple task that removes a local directory called <code>target</code> could look like this:</p><code><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36">{<span style="color:#f1fa8c">:min-bb-version</span> <span style="color:#f1fa8c">&#34;0.4.0&#34;</span>,
 <span style="color:#f1fa8c">:tasks</span> {<span style="color:#8be9fd;font-style:italic">clean</span> (<span style="color:#ff79c6">do </span>(<span style="color:#8be9fd;font-style:italic">println </span><span style="color:#f1fa8c">&#34;Removing target folder.&#34;</span>)
                   (<span style="color:#50fa7b">babashka.fs/delete-tree</span> <span style="color:#f1fa8c">&#34;target&#34;</span>))}}</pre></code><p>And you could run this task with <code>bb run clean</code> or the shorter version <code>bb clean</code>. Running this task on my computer takes about 26 milliseconds.</p><code><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36">❯ time bb clean
Removing target folder.
bb clean  0.02s user 0.01s system 101% cpu 0.026 total</pre></code><p>To get a sense of how fast Babashka starts up compared to JVM Clojure, this is how long it takes JVM Clojure to print out a single line of text to the terminal:</p><code><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36">❯ time clojure -M test.clj
The JVM startup penalty is something fierce!
clojure -M test.clj  2.85s user 0.15s system 188% cpu 1.594 total</pre></code><p>1594 milliseconds! Not exactly the performance you want for simple and short Bash-like scripts.</p><p>So after playing around with Babashka for a while, I decided to write some Babashka tasks that could backup and restore my databases for me. Here&apos;s what I came up with:</p><code><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36"><span style="color:#6272a4">; run `bb backup` to backup database</span>
<span style="color:#6272a4">; run `bb restore` to restore latest backup</span>

{<span style="color:#f1fa8c">:min-bb-version</span> <span style="color:#f1fa8c">&#34;0.4.0&#34;</span>,
 <span style="color:#f1fa8c">:tasks</span> {<span style="color:#6272a4">; CONSTANTS</span>
         <span style="color:#8be9fd;font-style:italic">db-name</span> <span style="color:#f1fa8c">&#34;dev_blog&#34;</span>,
         <span style="color:#8be9fd;font-style:italic">backup-dir</span> <span style="color:#f1fa8c">&#34;backups&#34;</span>,
         <span style="color:#8be9fd;font-style:italic">now</span> (<span style="color:#8be9fd;font-style:italic">str </span>(<span style="color:#50fa7b">java.time.LocalDateTime/now</span>)),
         <span style="color:#6272a4">; TASKS</span>
         <span style="color:#8be9fd;font-style:italic">create-backup-dir</span> {<span style="color:#f1fa8c">:depends</span> [<span style="color:#8be9fd;font-style:italic">backup-dir</span>], <span style="color:#f1fa8c">:task</span> (<span style="color:#50fa7b">babashka.fs/create-dirs</span> <span style="color:#8be9fd;font-style:italic">backup-dir</span>)},
         <span style="color:#8be9fd;font-style:italic">backup</span> {<span style="color:#f1fa8c">:depends</span> [<span style="color:#8be9fd;font-style:italic">db-name</span> <span style="color:#8be9fd;font-style:italic">now</span> <span style="color:#8be9fd;font-style:italic">backup-dir</span> <span style="color:#8be9fd;font-style:italic">create-backup-dir</span>],
                 <span style="color:#f1fa8c">:task</span> (<span style="color:#ff79c6">let </span>[<span style="color:#8be9fd;font-style:italic">backup-path</span> (<span style="color:#8be9fd;font-style:italic">str </span><span style="color:#8be9fd;font-style:italic">backup-dir</span> <span style="color:#f1fa8c">&#34;/&#34;</span> <span style="color:#8be9fd;font-style:italic">db-name</span> <span style="color:#f1fa8c">&#34;_backup:&#34;</span> <span style="color:#8be9fd;font-style:italic">now</span> <span style="color:#f1fa8c">&#34;.dump&#34;</span>)
                             <span style="color:#8be9fd;font-style:italic">backup-command</span> (<span style="color:#8be9fd;font-style:italic">str </span><span style="color:#f1fa8c">&#34;pg_dump --format=custom &#34;</span> <span style="color:#8be9fd;font-style:italic">db-name</span>)]
                         (<span style="color:#ff79c6">do </span>(<span style="color:#8be9fd;font-style:italic">println </span>(<span style="color:#8be9fd;font-style:italic">str </span><span style="color:#f1fa8c">&#34;Backing up database: &#34;</span> <span style="color:#8be9fd;font-style:italic">db-name</span>))
                             (<span style="color:#8be9fd;font-style:italic">println </span>(<span style="color:#8be9fd;font-style:italic">str </span><span style="color:#f1fa8c">&#34;Backup location: &#34;</span> <span style="color:#8be9fd;font-style:italic">backup-path</span>))
                             (<span style="color:#ff79c6">if </span>(<span style="color:#8be9fd;font-style:italic">-&gt; </span>(<span style="color:#50fa7b">shell</span> {<span style="color:#f1fa8c">:out</span> <span style="color:#8be9fd;font-style:italic">backup-path</span>} <span style="color:#8be9fd;font-style:italic">backup-command</span>)
                                     (<span style="color:#f1fa8c">:exit</span>)
                                     (<span style="color:#8be9fd;font-style:italic">= </span><span style="color:#bd93f9">0</span>))
                               (<span style="color:#8be9fd;font-style:italic">println </span><span style="color:#f1fa8c">&#34;Backup successful! 🚀&#34;</span>)
                               (<span style="color:#8be9fd;font-style:italic">println </span><span style="color:#f1fa8c">&#34;Errors occurred during backup ⚠️&#34;</span>))))},
         <span style="color:#8be9fd;font-style:italic">restore</span> {<span style="color:#f1fa8c">:depends</span> [<span style="color:#8be9fd;font-style:italic">db-name</span> <span style="color:#8be9fd;font-style:italic">backup-dir</span>],
                  <span style="color:#f1fa8c">:task</span> (<span style="color:#ff79c6">let </span>[<span style="color:#8be9fd;font-style:italic">latest-backup-path</span> (<span style="color:#8be9fd;font-style:italic">-&gt; </span>(<span style="color:#50fa7b">babashka.fs/list-dir</span> <span style="color:#8be9fd;font-style:italic">backup-dir</span>)
                                                     (<span style="color:#50fa7b">sort</span>)
                                                     (<span style="color:#50fa7b">reverse</span>)
                                                     (<span style="color:#50fa7b">first</span>)
                                                     (<span style="color:#50fa7b">str</span>))
                              <span style="color:#8be9fd;font-style:italic">restore-command</span> (<span style="color:#8be9fd;font-style:italic">str </span><span style="color:#f1fa8c">&#34;pg_restore --clean --dbname=&#34;</span> <span style="color:#8be9fd;font-style:italic">db-name</span> <span style="color:#f1fa8c">&#34; &#34;</span> <span style="color:#8be9fd;font-style:italic">latest-backup-path</span>)
                              <span style="color:#8be9fd;font-style:italic">do-restore?</span> (<span style="color:#ff79c6">do </span>(<span style="color:#8be9fd;font-style:italic">println </span><span style="color:#f1fa8c">&#34;Latest backup: &#34;</span> <span style="color:#8be9fd;font-style:italic">latest-backup-path</span>)
                                              (<span style="color:#8be9fd;font-style:italic">println </span><span style="color:#f1fa8c">&#34;Restore command: &#34;</span> <span style="color:#8be9fd;font-style:italic">restore-command</span>)
                                              (<span style="color:#8be9fd;font-style:italic">println </span><span style="color:#f1fa8c">&#34;Restore this backup? (y/n): &#34;</span>)
                                              (<span style="color:#8be9fd;font-style:italic">= </span>(<span style="color:#8be9fd;font-style:italic">first </span>(<span style="color:#8be9fd;font-style:italic">line-seq </span>(<span style="color:#50fa7b">clojure.java.io/reader</span> <span style="color:#8be9fd;font-style:italic">*in*</span>))) <span style="color:#f1fa8c">&#34;y&#34;</span>))]
                          (<span style="color:#ff79c6">if </span><span style="color:#8be9fd;font-style:italic">do-restore?</span>
                            (<span style="color:#ff79c6">do </span>(<span style="color:#8be9fd;font-style:italic">println </span><span style="color:#f1fa8c">&#34;Restoring database... &#34;</span>)
                                (<span style="color:#ff79c6">if </span>(<span style="color:#8be9fd;font-style:italic">-&gt; </span>(<span style="color:#50fa7b">shell</span> <span style="color:#8be9fd;font-style:italic">restore-command</span>)
                                        (<span style="color:#f1fa8c">:exit</span>)
                                        (<span style="color:#8be9fd;font-style:italic">= </span><span style="color:#bd93f9">0</span>))
                                  (<span style="color:#8be9fd;font-style:italic">println </span><span style="color:#f1fa8c">&#34;Restoration successful! 🚀&#34;</span>)
                                  (<span style="color:#8be9fd;font-style:italic">println </span><span style="color:#f1fa8c">&#34;Errors occurred during restoration ⚠️&#34;</span>)))
                            (<span style="color:#8be9fd;font-style:italic">println </span><span style="color:#f1fa8c">&#34;Skipping restoration...&#34;</span>)))}}}</pre></code><p>Now I can simply run <code>bb backup</code> and <code>bb restore</code> when I want to interact with my backups. It&apos;s so much easier than manually typing in the <code>pg_dump</code> and <code>pg_restore</code> commands, and in my opinion this code is <strong>much</strong> more readable than a shell script that could do the equivalent. I&apos;m definitely biased because I love Clojure and dislike shell scripting, but I think many beginner programmers would also agree!</p><p>Here&apos;s what it looks like when I want to backup a database:</p><code><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36">❯ bb backup
Backing up database: dev_blog
Backup location: backups/dev_blog_backup:2021-07-23T14:24:22.754740.dump
Backup successful! 🚀</pre></code><p>And when I want to restore from a backup:</p><code><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36">❯ bb restore
Latest backup:  backups/dev_blog_backup:2021-07-23T14:24:22.754740.dump
Restore command:  pg_restore --clean --dbname=dev_blog backups/dev_blog_backup:2021-07-23T14:24:22.754740.dump
Restore this backup? (y/n):
y
Restoring database...
Restoration successful! 🚀</pre></code><p>An overview of the <code>pg_*</code> commands I&apos;m using within this program:</p><ul><li><p><code>pg_dump --format=custom &lt;db-name&gt;</code>: I&apos;m using the <code>--format=custom</code> flag because this saves the backup in a format that makes it trivally easy to restore using <code>pg_restore</code>. I tried using the default <code>--format=plain</code> which saves the backup as a plain text SQL file, but you can&apos;t actually restore these backups using <code>pg_restore</code>. You have to pipe the file into the <code>psql</code> command which I found difficult to do in Babashka. <code>--format=custom</code> seems to be the superior choice for ease of use anyway.</p></li><li><p><code>pg_restore --clean --dbname=&lt;dn-name&gt; &lt;path-to-backup&gt;</code>: I&apos;m using the <code>--clean</code> flag here because this drops the database before the backup is loaded. Since everything about the database is contained within the backup, this is the behavior I want.</p></li></ul><p>For short and sweet Bash-like scripts, Babashka is incredible. If you also enjoy using Clojure and need to write shell scripts, definitely consider using it! And feel free to take these Babashka tasks for backing up your own PostgreSQL databases!</p><p>References:<br /><a href="https://gist.github.com/stelcodes/a8c3b8f4b9c07ef784675750ab91079e">Gist</a><br /><a href="https://github.com/babashka/babashka/discussions/929">Babashka Show &amp; Tell</a></p><div class="circles"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-circle"><circle cx="12" cy="12" r="10"></circle></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-circle"><circle cx="12" cy="12" r="10"></circle></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-circle"><circle cx="12" cy="12" r="10"></circle></svg></div></article></div></section></main><footer><p>Stel Abrego 2021</p></footer></body></html>